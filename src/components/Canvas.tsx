import React, { useRef, useState, useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import Ruler from "@scena/react-ruler";
import { RootState } from '../store/store';
import { selectElement, addElement, updateCanvasSettings } from '../store/editorSlice';
import RuntimeElement from './RuntimeElement'; 

export default function Canvas() {
  const { elements, selectedId, canvasSettings } = useSelector((state: RootState) => state.editor);
  const dispatch = useDispatch();

  // ğŸ“ ë£°ëŸ¬ ë‘ê»˜ ìƒìˆ˜ (30pxì´ ê°€ì¥ ì•ˆì •ì )
  const RULER_THICKNESS = 30;

  // Refs
  const rulerHorz = useRef<Ruler>(null);
  const rulerVert = useRef<Ruler>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const horzContainerRef = useRef<HTMLDivElement>(null);
  const vertContainerRef = useRef<HTMLDivElement>(null);
  
  // ğŸ‘‡ í´ë¦­ vs ë“œë˜ê·¸ êµ¬ë¶„ì„ ìœ„í•œ ìœ„ì¹˜ ì €ì¥ì†Œ
  const dragStartPosRef = useRef({ x: 0, y: 0 });

  // Local State
  const [isPanning, setIsPanning] = useState(false);
  const [startPan, setStartPan] = useState({ x: 0, y: 0 });
  const [startScroll, setStartScroll] = useState({ x: 0, y: 0 });
  const [isSpacePressed, setIsSpacePressed] = useState(false);

  // --- 1. ResizeObserverë¡œ ë£°ëŸ¬ ìë™ ì—…ë°ì´íŠ¸ (ê¹¨ì§ ë°©ì§€) ---
  useEffect(() => {
    const resizeObserver = new ResizeObserver(() => {
      if (rulerHorz.current) rulerHorz.current.resize();
      if (rulerVert.current) rulerVert.current.resize();
    });

    if (horzContainerRef.current) resizeObserver.observe(horzContainerRef.current);
    if (vertContainerRef.current) resizeObserver.observe(vertContainerRef.current);

    return () => resizeObserver.disconnect();
  }, []);

  // --- 2. ìŠ¤í˜ì´ìŠ¤ë°” ê°ì§€ ---
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      if (e.code === 'Space' && !e.repeat) {
        e.preventDefault(); 
        setIsSpacePressed(true);
      }
    };
    const handleKeyUp = (e: KeyboardEvent) => {
      if (e.code === 'Space') {
        setIsSpacePressed(false);
        setIsPanning(false);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, []);

  // --- 3. ì¤Œ í•¸ë“¤ëŸ¬ ---
  const handleZoom = (delta: number) => {
    const newZoom = Math.max(0.1, Math.min(canvasSettings.zoom + delta, 3));
    dispatch(updateCanvasSettings({ zoom: newZoom }));
    // ì¤Œ ë³€ê²½ ì§í›„ ë¦¬ì‚¬ì´ì¦ˆ ì•ˆì „ì¥ì¹˜
    setTimeout(() => {
        rulerHorz.current?.resize();
        rulerVert.current?.resize();
    }, 0);
  };

  // --- 4. íœ  í•¸ë“¤ëŸ¬ ---
  const handleWheel = (e: React.WheelEvent) => {
    if (e.ctrlKey) {
      handleZoom(e.deltaY > 0 ? -0.1 : 0.1);
    } else {
      dispatch(updateCanvasSettings({
        scrollX: canvasSettings.scrollX - e.deltaX,
        scrollY: canvasSettings.scrollY - e.deltaY
      }));
    }
  };

  // --- 5. ë“œë˜ê·¸(Pan) ì‹œì‘ ---
  const handleMouseDown = (e: React.MouseEvent) => {
    // í´ë¦­ ì‹œì‘ ìœ„ì¹˜ ì €ì¥ (ë‚˜ì¤‘ì— ë“œë˜ê·¸ ì—¬ë¶€ íŒë‹¨ìš©)
    dragStartPosRef.current = { x: e.clientX, y: e.clientY };

    // íœ  ë²„íŠ¼(1) ë˜ëŠ” (ìŠ¤í˜ì´ìŠ¤ë°” + ì¢Œí´ë¦­)
    if (e.button === 1 || (isSpacePressed && e.button === 0)) {
      e.preventDefault();
      setIsPanning(true);
      setStartPan({ x: e.clientX, y: e.clientY });
      setStartScroll({ x: canvasSettings.scrollX, y: canvasSettings.scrollY });
    }
  };

  // --- 6. ì „ì—­ ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì´ë™) ---
  useEffect(() => {
    if (!isPanning) return;

    const handleWindowMouseMove = (e: MouseEvent) => {
      const dx = e.clientX - startPan.x;
      const dy = e.clientY - startPan.y;
      dispatch(updateCanvasSettings({
        scrollX: startScroll.x + dx,
        scrollY: startScroll.y + dy
      }));
    };

    const handleWindowMouseUp = () => {
      setIsPanning(false);
    };

    window.addEventListener('mousemove', handleWindowMouseMove);
    window.addEventListener('mouseup', handleWindowMouseUp);
    return () => {
      window.removeEventListener('mousemove', handleWindowMouseMove);
      window.removeEventListener('mouseup', handleWindowMouseUp);
    };
  }, [isPanning, startPan, startScroll, dispatch]);

  // --- 7. ë°°ê²½ í´ë¦­ í•¸ë“¤ëŸ¬ (ë“œë˜ê·¸ ì—¬ë¶€ í™•ì¸ í›„ ì„ íƒ í•´ì œ) ---
  const handleCanvasClick = (e: React.MouseEvent) => {
    // ì´ë™ ê±°ë¦¬ ê³„ì‚°
    const dist = Math.sqrt(
      Math.pow(e.clientX - dragStartPosRef.current.x, 2) + 
      Math.pow(e.clientY - dragStartPosRef.current.y, 2)
    );

    // 5px ì´ìƒ ì›€ì§ì˜€ìœ¼ë©´ "ë“œë˜ê·¸"ë¡œ íŒë‹¨í•˜ê³  ë¬´ì‹œ
    if (dist > 5) return;

    // ë“œë˜ê·¸ê°€ ì•„ë‹ˆê³  ìŠ¤í˜ì´ìŠ¤ë°”ë„ ì•ˆ ëˆŒë €ìœ¼ë©´ -> ì„ íƒ í•´ì œ
    if (!isSpacePressed) {
      dispatch(selectElement(null));
    }
  };

  // --- 8. ë“œë¡­ í•¸ë“¤ëŸ¬ ---
  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    const imageSrc = e.dataTransfer.getData('imageSrc');
    
    if (imageSrc) {
        const rect = containerRef.current?.getBoundingClientRect();
        if (!rect) return;
        
        // ë£°ëŸ¬, ìŠ¤í¬ë¡¤, ì¤Œì„ ê³ ë ¤í•œ ì¢Œí‘œ ê³„ì‚°
        const dropX = (e.clientX - rect.left - RULER_THICKNESS - canvasSettings.scrollX) / canvasSettings.zoom;
        const dropY = (e.clientY - rect.top - RULER_THICKNESS - canvasSettings.scrollY) / canvasSettings.zoom;

        const newElement = {
            id: Date.now().toString(),
            type: 'Image' as const,
            props: { 
                src: imageSrc, 
                width: '200px', height: 'auto', backgroundColor: 'transparent',
                left: `${dropX}px`, top: `${dropY}px`
            },
            scripts: []
        };
        dispatch(addElement(newElement));
    }
  };

  const cursorStyle = isPanning ? 'cursor-grabbing' : (isSpacePressed ? 'cursor-grab' : 'cursor-default');

  return (
    <main className="flex-1 flex flex-col h-full bg-gray-100 overflow-hidden relative select-none">
      
      {/* ì¤Œ ì»¨íŠ¸ë¡¤ */}
      <div className="absolute top-10 right-5 z-50 flex gap-2 bg-white p-2 rounded shadow-md border border-gray-200">
        <button onClick={() => handleZoom(-0.1)} className="px-2 py-1 hover:bg-gray-100 rounded">-</button>
        <span className="px-2 py-1 text-sm font-mono w-12 text-center">{Math.round(canvasSettings.zoom * 100)}%</span>
        <button onClick={() => handleZoom(0.1)} className="px-2 py-1 hover:bg-gray-100 rounded">+</button>
        <button onClick={() => dispatch(updateCanvasSettings({ zoom: 1, scrollX: 0, scrollY: 0 }))} className="px-2 py-1 text-xs text-blue-500 hover:bg-blue-50 rounded ml-2">Reset</button>
      </div>

      {/* --- ìƒë‹¨ ì˜ì—­ (ê°€ë¡œ ë£°ëŸ¬) --- */}
      <div className="flex w-full z-40 bg-white border-b border-gray-300 flex-none" style={{ height: RULER_THICKNESS }}>
        <div 
            className="bg-gray-50 border-r border-gray-300 flex-none z-50 flex items-center justify-center text-[10px] text-gray-500 font-bold"
            style={{ width: RULER_THICKNESS, height: RULER_THICKNESS }}
        >
          px
        </div>
        <div className="flex-1 relative overflow-hidden" ref={horzContainerRef}>
          <Ruler
            ref={rulerHorz}
            type="horizontal"
            unit={50}
            zoom={canvasSettings.zoom}
            scrollPos={-canvasSettings.scrollX / canvasSettings.zoom}
            backgroundColor="#ffffff"
            lineColor="#cbd5e1"
            textColor="#64748b"
            textOffset={[0, 8]}
            style={{ fontFamily: 'sans-serif', fontSize: '10px', width: '100%', height: '100%' }}
          />
        </div>
      </div>

      <div className="flex flex-1 w-full h-full overflow-hidden relative">
        {/* --- ì¢Œì¸¡ ì˜ì—­ (ì„¸ë¡œ ë£°ëŸ¬) --- */}
        <div 
            className="bg-white border-r border-gray-300 z-40 relative flex-none overflow-hidden"
            style={{ width: RULER_THICKNESS }}
            ref={vertContainerRef}
        >
          <Ruler
            ref={rulerVert}
            type="vertical"
            unit={50}
            zoom={canvasSettings.zoom}
            scrollPos={-canvasSettings.scrollY / canvasSettings.zoom}
            backgroundColor="#ffffff"
            lineColor="#cbd5e1"
            textColor="#64748b"
            textOffset={[8, 0]}
            style={{ fontFamily: 'sans-serif', fontSize: '10px', width: '100%', height: '100%' }}
          />
        </div>

        {/* --- ë·°í¬íŠ¸ --- */}
        <div 
            ref={containerRef}
            className={`flex-1 relative bg-gray-200 overflow-hidden ${cursorStyle}`}
            onMouseDown={handleMouseDown}
            onWheel={handleWheel}
            onDragOver={(e) => e.preventDefault()}
            onDrop={handleDrop}
            // ğŸ‘‡ í´ë¦­ í•¸ë“¤ëŸ¬ ì—°ê²°
            onClick={handleCanvasClick}
        >
            {/* ìº”ë²„ìŠ¤ ì¢…ì´ */}
            <div 
                className="absolute origin-top-left bg-white shadow-2xl"
                style={{
                    width: `${canvasSettings.width}px`,
                    height: `${canvasSettings.height}px`,
                    backgroundColor: canvasSettings.backgroundColor,
                    transform: `translate(${canvasSettings.scrollX}px, ${canvasSettings.scrollY}px) scale(${canvasSettings.zoom})`,
                }}
                // ì¢…ì´ ìœ„ë¥¼ í´ë¦­í–ˆì„ ë•Œë„ ë“œë˜ê·¸ ì—¬ë¶€ ì²´í¬
                onClick={(e) => {
                    const dist = Math.sqrt(Math.pow(e.clientX - dragStartPosRef.current.x, 2) + Math.pow(e.clientY - dragStartPosRef.current.y, 2));
                    if (dist > 5) return; // ë“œë˜ê·¸ë©´ ë¬´ì‹œ
                    if (!isSpacePressed) e.stopPropagation(); // í´ë¦­ì´ë©´ ìƒìœ„(ì„ íƒí•´ì œ)ë¡œ ì „íŒŒ ë°©ì§€
                }}
            >
                {elements.map((el) => (
                    <RuntimeElement 
                        key={el.id} 
                        element={el} 
                        selectedId={selectedId} 
                        mode="edit" 
                    />
                ))}
            </div>
        </div>
      </div>
    </main>
  );
}